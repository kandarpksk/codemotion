<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>Codemotion UI</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link href="css/main.css" rel="stylesheet">
</head>
<body>
	<div class="container">
		<br>
		<br>
		<div class="row">
			<div class="col-md-8">
				<h1>{{ name }}</h1>
			</div>
			<div class="input-group col-md-4" id="custom-search-input" style="margin-left: -15px">
				<input type="text" class="form-control input-lg" placeholder="Look for code fragments" />
				<span class="input-group-btn">
					<button class="btn btn-info btn-lg" type="button" onclick="showMarkers()">
						<i class="material-icons">search</i>
					</button>
				</span>
			</div>
		</div>
		<br>
		<br>

		{{#each segments}}
		<div class="alert alert-info" role="alert" id="s{{start}}-vo">
			{{voiceover}}
		</div>

		<div class="row transcript">
			<div class="col-sm-5 video-container">
				<!-- http://codepen.io/ollieRogers/pen/lfeLc -->
				<span class="badge badge-pill badge-default">
					<i class="material-icons fs">fullscreen</i>
				</span>
				<video preload="metadata" id="s{{start}}-video">
					<source src="{{ url }}#t={{start}}" type="video/mp4" />
					Your browser does not support HTML5 video.
				</video>

				<div id="scrubber">
					<div id="progress">
						{{#if @index}}
						<div class="marker" id="m0" style="left:30%; display:none"></div>
						<div class="marker" id="m1" style="left:50%; display:none"></div>
						<div class="marker" id="m1" style="left:90%; display:none"></div>
						{{/if}}
					</div>
				</div>
			</div>
			<div class="col code-container">
				{{#each code}}
				<textarea style="display: none;"
						id="s{{../start}}l{{@index}}-code" data-language="{{ this.language }}">{{ this.text }}</textarea>
				{{/each}}
				<div class="editor" id="s{{start}}-editor"
						data-language="{{ code.[0].language }}">{{ code.[0].text }}</div>
			</div>
			<div class="pills">
				<ul class="nav nav-pills">
					{{#each code}}
					<li class="nav-item">
						<a class="nav-link{{#if @first}} active{{/if}}"
								href="#" onclick="showCode(event, this)"
								data-s-index="{{../start}}" data-l-index="{{@index}}">
							{{ this.l }}
						</a>
					</li>
					{{/each}}
				</ul>
			</div>
		</div>

		{{/each}}
		<br>
	</div>

	<!-- todo: keep locally -->
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<!-- <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"></script>
	<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/initialize-ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/initialize-scrubbers.js" type="text/javascript" charset="utf-8"></script>
	<script>
		function showCode(event, e) {
			event.preventDefault()
			var pills = e.parentNode.parentNode
			pills.getElementsByClassName('nav-link active')[0].className = 'nav-link'
			$(e).attr('class', 'nav-link active')
			var s_index = $(e).data('s-index')
			var id = 's'+s_index + 'l'+$(e).data('l-index') + '-code'
			var text = document.getElementById(id).innerHTML
			console.log(text)
			var editor = ace.edit('s'+s_index+'-editor')
			editor.session.setValue(text)
			editor.getSession().setMode('ace/mode/'+$('#'+id).data('language'))
		}

		function showScript() {
			{{#each segments}}
			var video = $('#s'+{{start}}+'-video')[0]
			var scriptDiv = $('#s'+{{start}}+'-vo')
			var time = Math.round(video.currentTime*100)/100
			scriptDiv.html('voiceover at '+time)
			{{/each}}
		}

		function initializeVideo() {
			var video, fs_button
			{{#each segments}}
			video = $('#s'+{{start}}+'-video')[0]
			// video.currentTime = {{start}}
			fs_button = $(video.parentNode).find('.fs')[0]
			fs_button.addEventListener("click", function() {
				var video = $('#s'+{{start}}+'-video')[0]
				if (video.requestFullscreen)
					video.requestFullscreen()
				else if (video.mozRequestFullScreen)
					video.mozRequestFullScreen()
				else if (video.webkitRequestFullscreen)
					video.webkitRequestFullscreen()
			})
			{{/each}}

			$('.video-container video').click(function() {
				if (this.paused) this.play()
				else this.pause()
			})

			setInterval(showScript, 100)
		}

		$(document).ready(function() {
			initializeScrubbers()
			$('.editor').each(initializeAce)

			initializeVideo()
		})

		function showMarkers() {
			$('.marker').each(function() { $(this).show() })
		}
	</script>
</body>
</html>
